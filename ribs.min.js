(function(){var t={}.hasOwnProperty,e=function(e,i){function s(){this.constructor=e}for(var o in i)t.call(i,o)&&(e[o]=i[o]);return s.prototype=i.prototype,e.prototype=new s,e.__super__=i.prototype,e};(function(t){var i;return i="undefined"!=typeof window&&null!==window?window:module.exports,i.Ribs={},Ribs.List=function(i){function s(t){var e,i,o,n,l,r;for(this.sortArrows={},this.sortArrows[-1]="↓",this.sortArrows[1]="↑",this.className||(this.className=""),this.className+=" ribs",null==(l=this.itemView)&&(this.itemView=Ribs.ListItem),this.events||(this.events={}),_.extend(this.events,this._ribsEvents),_.extend(this,t),s.__super__.constructor.call(this,t),this.initializeHotKeys(),this.components=[],r=this.renderOrder,o=0,n=r.length;n>o;o++)i=r[o],e=i.replace(/^./,"$"+i[0].toLowerCase()),this["suppress"+i]||(this[e]=this["initialize"+i]()),e in this&&this.components.push(this[e]);this.$el.addClass("ribs"),this.build()}return e(s,i),s.prototype.tagName="div",s.prototype.itemName="item",s.prototype._ribsEvents={keypress:"keypressed",focusin:"focusin",focusout:"focusout","click .header .toggle":"toggleSelected","click .maximize .minimize":"toggleVisibility","click [data-sort-by]":"sortByField"},s.prototype.jumpSelector=".list li:first",s.prototype.focussed=!1,s.prototype.selectedByDefault=!1,s.prototype.stopPropogation=function(t){return t.preventDefault()},s.prototype.renderOrder=["Title","Actions","Header","List","Footer"],s.prototype.build=function(){var t,e,i,s;for(this.$el.empty(),s=this.components,e=0,i=s.length;i>e;e++)t=s[e],this.$el.append(t);return this._subviews=[],null!=this.collection?this.setCollection(this.collection):void 0},s.prototype.render=function(){var t,e,i,s,o;for(o=this._subviews,t=i=0,s=o.length;s>i;t=++i)e=o[t],e.render();return this.$footer&&this.updateFooter,this.$header?this.updateHeader:void 0},s.prototype.setCollection=function(t){var e,i,s,o;for(this.collection=t,o=this.allActions,i=0,s=o.length;s>i;i++)e=o[i],null!=e&&e.setCollection(this.collection);return this.collection.off("selected deselected reset add remove",null,this),this.collection.on("add",this.addItem,this),this.collection.on("reset",this.addAllItems,this),this.$header&&this.collection.on("selected deselected reset add remove",this.updateHeader,this),this.$footer&&this.collection.on("selected deselected reset add remove",this.updateFooter,this),this.addAllItems()},s.prototype.getSelected=function(){var e=this;return null==this.$list?[]:this.$list.find(".item.selected").map(function(i,s){return e.collection.get(t(s).data("cid"))})},s.prototype.getDeselected=function(){var e=this;return null==this.$list?[]:this.$list.find(".item:not(.selected)").map(function(i,s){return e.collection.get(t(s).data("cid"))})},s.prototype.getNumSelected=function(){return null==this.$list?0:this.$list.find(".item.selected").size()},s.prototype.getNumDeselected=function(){return null==this.$list?0:this.$list.find(".item:not(.selected)").size()},s.prototype.getNumTotal=function(){return null==this.collection?0:this.collection.length},s.prototype.toggleFocussedSelected=function(){return this.suppressToggle?void 0:this.$(".item:focus").trigger("toggle")},s.prototype.toggleSelected=function(){var t,e;return this.selectedByDefault===!0?(this.$list.find(".item.selected").trigger("deselect",{silent:!0}),this.selectedByDefault=!1,null!=(t=this.collection)?t.trigger("deselected"):void 0):(this.$list.find(".item:not(.selected)").trigger("select",{silent:!0}),this.selectedByDefault=!0,null!=(e=this.collection)?e.trigger("selected"):void 0)},s.prototype.invertSelected=function(){var t,e;return e=this.$list.find(":not(.item.selected)"),t=this.$list.find(".item.selected"),e.trigger("select"),t.trigger("deselect")},s.prototype.toggleVisibility=function(){return this.$header.find(".maximize, .minimize").toggle(),null==this.$el.attr("class")&&this.$el.attr("class",""),this.$el.toggleClass("minimized",100)},s.prototype.sortByField=function(e){var i,s,o;return s=t(e.target).attr("data-sort-by"),null!=s?(o=this.sortingBy,this.sortingDirection||(this.sortingDirection={}),this.sortingBy=s,s===o&&s in this.sortingDirection?this.sortingDirection[s]*=-1:this.sortingDirection[s]=1,i=this.sortingDirection[s],this.sortCollection(s,i),this.updateHeaderArrows(s,o)):void 0},s.prototype.sortCollection=function(t,e){var i=this;return this.collection.remoteSort?this.collection.trigger("remoteSort",t,e):(this.collection.comparator=function(s,o){var n,l,r,c;return n=s.get(t),r=i.displayAttributeMap[t],null!=r.map&&(n=r.map(n)),l=o.get(t),c=i.displayAttributeMap[t],null!=c.map&&(l=c.map(l)),null!=(null!=n?n.toLowerCase:void 0)&&(n=n.toLowerCase()),null!=(null!=l?l.toLowerCase:void 0)&&(l=l.toLowerCase()),n===l?0:n>l||null==l?1*e:l>n||null==n?-1*e:void 0},this.collection.sort())},s.prototype.updateHeaderArrows=function(e,i){var s,o,n,l,r,c,a,h,u;if(null!=this.collection)return c=RegExp(" ("+_.values(this.sortArrows).join("|")+")$|$"),s=null!=(a=this.sortingDirection[e])?a:1,null!=i&&(l=this.$header.find("[data-sort-by='"+i+"']"),r=null!=(h=l.html())?h.replace(c,""):void 0,t(l).html(r)),o=this.$header.find("[data-sort-by='"+e+"']"),n=null!=(u=t(o).html())?u.replace(c," "+this.sortArrows[s]):void 0,t(o).html(n)},s.prototype.initializeHotKeys=function(){var e,i,s,o,n,l,r,c=this;for(null==(l=(s=this.constructor).keyboardManager)&&(s.keyboardManager=new Ribs.KeyboardManager),this.keyboardManager=this.constructor.keyboardManager,this.keyboardNamespace=this.keyboardManager.registerView(this,this.plural()),null!=this.jumpkey&&this.keyboardManager.registerJumpKey({label:this.plural(),jumpkey:this.jumpkey,context:this,callback:function(){return c.$(c.jumpSelector).focus()},precondition:function(){return c.$el.is(":visible")}}),i=[{hotkey:"j",label:"Focus next item",callback:function(){return t(document.activeElement).nextAll(".item:visible:not(.disabled):first").focus()}},{hotkey:"J",label:"Focus last item",callback:function(){return c.$list.find(".item:last").focus()}},{hotkey:"k",label:"Focus previous item",callback:function(){return t(document.activeElement).prevAll(".item:visible:not(.disabled):first").focus()}},{hotkey:"K",label:"Focus first item",callback:function(){return c.$list.find(".item:first").focus()}},{hotkey:"x",label:"Select/deselect item",callback:function(){return c.toggleFocussedSelected()}},{hotkey:"X",label:"Select/deselect all",callback:function(){return c.toggleSelected()}},{hotkey:"_",label:"Expand/collapse list",callback:function(){return c.toggleVisibility()}},{hotkey:"R",label:"Refresh items",callback:function(){return c.refresh()}}],r=[],o=0,n=i.length;n>o;o++)e=i[o],e.namespace=this.keyboardNamespace,r.push(this.keyboardManager.registerHotKey(e));return r},s.prototype.keypressed=function(t){return this.trigger("keypressed",t),this.keyboardManager.handleKeypress(t,this.keyboardNamespace)},s.prototype.refresh=function(){var t=this;return null!=this.collection.url?(this.trigger("refresh"),this.collection.fetch({success:function(){var e;return null!=(e=t.$list.find(".item:first"))?e.focus():void 0}})):void 0},s.prototype.focusin=function(){var t;return this.focussed||(this.focussed=!0),this.$el.addClass("focussed"),null!=(t=this.collection)?t.trigger("focusin"):void 0},s.prototype.focusout=function(){var t=this;return this.focussed?setTimeout(function(){var e;return 0===t.$(document.activeElement).length&&t.$el.removeClass("focussed"),t.focussed=!1,null!=(e=t.collection)?e.trigger("focusout"):void 0},10):void 0},s.prototype.plural=function(){var t;return null!=(t=this.itemNamePlural)?t:this.itemName+"s"},s.prototype.initializeTitle=function(){var e,i,s;return i=null!=(s=this.title)?s:this.plural(),i instanceof Function&&(i=i.call(this)),e=t(t.el.h1({"class":"title"},i))},s.prototype.initializeActions=function(){var e,i=this;return this.batchActions=[],this.inlineActions=[],this.allActions=[],e=t(t.el.ul({"class":"actions"})),_.each(this.actions,function(t){var s;return t.collection=i.collection,t.view=i,t.inline&&i.inlineActions.push(t),t.batch!==!1&&(s=new Ribs.Action(t),i.batchActions.push(s),i.allActions.push(s),s.render(),e.append(s.el)),t.hotkey?i.keyboardManager.registerHotKey({hotkey:t.hotkey,label:t.label,namespace:i.keyboardNamespace,context:t,precondition:t.allowed,callback:function(){return t.activate.call(i,i.getSelected())}}):void 0}),this.batchActions.length?e:null},s.prototype.initializeList=function(){var e;return e=t(t.el.ul({"class":"list"}))},s.prototype.addItem=function(t){var e,i,s,o;return i=Backbone.View.prototype.isPrototypeOf(this.itemView.prototype)?this.itemView:this.itemView(t),s=new i({model:t,view:this}),e=this.collection.indexOf(t),0===(o=this.$list.children().size())||o===e?this.$list.append(s.el):this.$list.children(":nth-child("+(e+1)+")").before(s.el),s.delegateEvents(),this.$el.is(":visible")&&s.render(),this._subviews.push(s),this.selectedByDefault?s.select():void 0},s.prototype.addAllItems=function(){var t;return this._subviews=[],this.$list.empty(),null!=(t=this.collection)&&t.each(this.addItem,this),this.trigger("rendered")},s.prototype.get=function(t){return _.find(this._subviews,function(e){return e.model.id===t})},s.prototype.getByCid=function(t){return _.find(this._subviews,function(e){return e.model.cid===t})},s.prototype.initializeHeader=function(){var e,i,s,o=this;return e=t(t.el.div({"class":"header"})),this.suppressToggle||(s=t.el.input({type:"checkbox",tabindex:-1}),this.selectedByDefault&&t(s).attr("checked","checked"),e.append(t.el.div({"class":"toggle"},s))),null==this.displayAttributes&&(i=_.map(this.collection.first().toJSON(),function(t,e){return{field:e}})),this.displayAttributeMap={},_.each(this.displayAttributes,function(i){var s,n,l,r;return o.displayAttributeMap[i.field]=i,n=null!=(l=i.label)?l:i.field,s=null!=(r=i["class"])?r:i.field,e.append(t.el.div({"class":s,"data-sort-by":i.sortField||i.field},n))}),e.find(".maximize, .minimize").click(function(){return o.toggleVisibility()}),e.find("[data-sort-by="+this.sortingBy+"]").append(" "+this.sortArrows[1]),e},s.prototype.updateHeader=function(){var t,e,i,s,o;return s=this.getNumSelected(),i=this.getNumTotal(),s>=i&&(this.selectedByDefault=!0),0===s&&(this.selectedByDefault=!1),t=0!==s,e=t&&i>s,o=e?.5:1,this.$header.find(".toggle input").attr("checked",t).css("opacity",o)},s.prototype.initializeFooter=function(){var e;return e=t(t.el.div({"class":"footer"}))},s.prototype.updateFooter=function(){var t,e;return t=1!==this.getNumTotal(),e=t?this.plural():this.itemName,this.$footer.text(""+this.getNumSelected()+" / "+this.getNumTotal()+" "+e+" selected")},s}(Backbone.View),Ribs.Action=function(i){function s(t){this.events||(this.events={}),_.extend(this.events,this._ribsEvents),s.__super__.constructor.call(this,t),this.options=_.extend({min:1,max:-1,arity:null,check:null},t),this.view=t.view,null!=this.collection&&this.setCollection(this.collection)}return e(s,i),s.prototype.tagName="li",s.prototype.className="action",s.prototype._ribsEvents={click:"activate",keypress:"keypressed"},s.prototype.setCollection=function(t){return null!=t&&(this.collection=t,this.collection.off("selected deselected reset",null,this),this.collection.on("selected deselected reset",this.checkRequirements,this)),this.checkRequirements()},s.prototype.checkRequirements=function(){var t;return t=this.allowed(),t||this.disable(),t?this.enable():void 0},s.prototype.allowed=function(){var t,e,i,s,o,n;return i=this.getNumSelected(),e=!1,null!=this.options.arity?(t=this.options.arity,s=t===i,o=-1===t,n=!!(t%1)&&i>=Math.floor(t),e=s||o||n):(s=-1===this.options.min||i>=this.options.min,o=-1===this.options.max||this.options.max>=i,e=s&&o),e&&null!=this.options.check&&(e=this.options.check.apply(this.view,[this.getSelected()])),e},s.prototype.getSelected=function(){return this.view.getSelected()},s.prototype.getNumSelected=function(){return this.view.getNumSelected()},s.prototype.disable=function(){return this.$el.addClass("disabled"),this.$(".button").attr("tabindex",-1)},s.prototype.enable=function(){return this.$el.removeClass("disabled"),this.$(".button").attr("tabindex",0)},s.prototype.render=function(){var e,i,s,o;return i=null!=(o=this.options.batchLabel)?o:this.options.label,null!=this.options.hotkey&&(i=this.constructor.highlightHotkey(i,this.options.hotkey)),s=this.$el.is(".disabled")?-1:0,e=t.el.div({"class":"button",tabindex:s,title:this.options.label}),t(e).html(i),this.$el.html(e)},s.prototype.activate=function(){return this.options.activate.call(this.view,this.getSelected())},s.prototype.keypressed=function(t){return 13===t.which?(this.activate(),!1):void 0},s.highlightHotkey=function(t,e){var i,s;return i=e,s=t.replace(i,"<span class='hotkey'><strong>"+i+"</strong></span>"),t===s&&(s=""+t+" <span class='hotkey'>[<strong>"+i+"</strong>]</span>"),s},s}(Backbone.View),Ribs.InlineAction=function(i){function s(){return s.__super__.constructor.apply(this,arguments)}return e(s,i),s.prototype.getSelected=function(){var t;return[null!=(t=this.options.listItem)?t.model:void 0]},s.prototype.getNumSelected=function(){return 1},s.prototype.render=function(){var e,i,s,o;return s=0,i=null!=(o=this.options.inlineLabel)?o:this.options.label,i instanceof Function&&(i=i.call(this,this.options.listItem.model)),e=t.el.div({"class":"inline button",tabindex:s,title:this.label},i),this.$el.html(e)},s}(Ribs.Action),Ribs.ListItem=function(i){function s(t){var e,i,o,n;for(this.events||(this.events={}),_.extend(this.events,this._ribsEvents),this.view=null!=t?t.view:void 0,this.listItemCells=[],n=this.view.displayAttributes,i=0,o=n.length;o>i;i++)e=n[i],e=_.clone(e),e.view=this,e.model=t.model,this.listItemCells.push(new Ribs.ListItemCell(e));s.__super__.constructor.call(this,t),null!=this.model&&(this.model.on("change",this.render,this),this.model.on("remove",this.remove,this),this.model.on("stealfocus",this.stealfocus,this))}return e(s,i),s.prototype.tagName="li",s.prototype.className="item",s.prototype.attributes={tabindex:0},s.prototype._ribsEvents={click:"toggle",toggle:"toggle",select:"select",deselect:"deselect","click a":"stopPropogation"},s.prototype.render=function(){var e,i,s,o,n,l,r,c,a,h,u,d;if(this.$el.empty(),this.model){for(this.$el.data("cid",this.model.cid),this.view.suppressToggle||(r=t.el.input({type:"checkbox",tabindex:-1}),this.$el.is(".selected")&&t(r).attr("checked",!0),this.$el.append(t.el.div({"class":"toggle"},r))),u=this.listItemCells,a=0,h=u.length;h>a;a++)i=u[a],i.render(),i.delegateEvents(),this.$el.append(i.el);n=this.model.toJSON(),c=t.el.ul({"class":"actions"}),d=this.view.inlineActions;for(o in d)e=d[o],(null==e.filter||e.filter(this.model)!==!1)&&(l=_.extend(e,{listItem:this}),s=new Ribs.InlineAction(l),s.render(),t(c).append(s.el));return this.$el.append(c)}},s.prototype.toggle=function(){return this.$el.is(".disabled")?void 0:this.$el.is(".selected")?this.deselect():this.select()},s.prototype.stopPropogation=function(t){return t.stopImmediatePropagation()},s.prototype.select=function(t,e){return null==e&&(e={}),this.view.suppressToggle?void 0:(this.$el.addClass("selected"),this.$("input:checkbox").attr("checked","checked"),e.silent?void 0:this.model.trigger("selected"))},s.prototype.deselect=function(t,e){return null==e&&(e={}),this.view.suppressToggle?void 0:(this.$el.removeClass("selected"),this.$("input:checkbox").removeAttr("checked"),e.silent?void 0:this.model.trigger("deselected"))},s.prototype.enable=function(){return this.$el.removeClass("disabled"),this.$("input:checkbox").removeAttr("disabled"),this.$el.attr("tabindex",0),this.model.trigger("enabled")},s.prototype.disable=function(){return this.$el.addClass("disabled"),this.$("input:checkbox").attr("disabled","disabled"),this.$el.attr("tabindex",-1),this.model.trigger("disabled")},s.prototype.remove=function(){return this.deselect(),s.__super__.remove.call(this)},s.prototype.stealfocus=function(){return this.$el.focus()},s}(Backbone.View),Ribs.ListItemCell=function(i){function s(t){var e;this.events||(this.events={}),_.extend(this.events,this._ribsEvents),_.extend(this,t),s.__super__.constructor.call(this,t),this.$el.addClass(null!=(e=this.options["class"])?e:this.options.field),this.model.on("change change:"+this.options.field,this.render,this)}return e(s,i),s.prototype.tagName="div",s.prototype.className="cell",s.prototype._ribsEvents={"click .edit":"edit","blur .editableField":"saveEditedField"},s.prototype.renderableValue=function(t){var e;return e=this.model.get(this.options.field),null==this.options.map||t||(e=this.options.map(e,this.model,this.$el)),e},s.prototype.render=function(){var e,i,s,o;return this.$el.empty(),this.options.escape?this.$el.text(this.renderableValue()):this.$el.html(this.renderableValue()),this.editable&&(i=null!=(s=this.options.label)?s:this.options.field,e=t.el.span({"class":"edit button inline",title:"Edit "+i},"✎"),null===(o=this.model.get(this.options.field))||""===o?t(e).addClass("show"):t(e).removeClass("show"),this.$el.append(e)),this},s.prototype.edit=function(){var e,i;return this.options.editable&&(i=this.model.get(this.options.field),e=this.options.editable instanceof Function?this.options.editable.call(this,i,this.model):t.el.input({type:"text",value:i}),e&&(t(e).addClass("editableField"),this.$el.html(e),this.delegateEvents(),t(e).focus())),!1},s.prototype.saveEditedField=function(e){var i,s,o;s=t(e.target),o=s.val(),i={},i[this.options.field]=o;try{return this.model.save(i,{wait:!0})}catch(e){return this.render()}},s}(Backbone.View),Ribs.KeyboardManager=function(){function e(e){var i=this;this.options=_.extend(this.options,e),this.registerHotKey({hotkey:"?",callback:this.showKeyboardBindings,context:this,label:"Show hotkeys"}),t(window).on("keypress",function(t){return i.handleKeypress(t)})}return e.prototype.boundCharCodes={},e.prototype.registeredViews={global:{bindings:[],tree:{},label:"Global",context:window}},e.prototype.options={jumpPrefixKey:"g",jumpTime:1e3,enableKeyboardShortcuts:!0},e.prototype.registerView=function(t,e){var i;return i=_.uniqueId("view"),this.registeredViews[i]={label:e,context:t,tree:{},bindings:[]},i},e.prototype.registerHotKey=function(t){var e,s,o,n,l,r,c,a,h,u;for(null==(c=t.charCodes)&&(t.charCodes=function(){var e,i,s,n;for(s=t.hotkey.split(""),n=[],e=0,i=s.length;i>e;e++)o=s[e],n.push(o.charCodeAt(0));return n}()),n=null!=(a=t.namespace)?a:t.namespace="global",i=this.registeredViews[n].tree,h=t.charCodes,s=l=0,r=h.length;r>l;s=++l)e=h[s],null==(u=i[e])&&(i[e]={bindings:[],upcoming:0}),s===t.charCodes.length-1?i[e].bindings.push(t):i[e].upcoming+=1,i=i[e];return this.registeredViews[n].bindings.push(t),n},e.prototype.registerJumpKey=function(t){return t.label="Go to "+t.label,t.hotkey=this.options.jumpPrefixKey+t.jumpkey,this.registerHotKey(t)},e.prototype.handleKeypress=function(e,i){var s,o;return null==i&&(i="global"),this.options.enableKeyboardShortcuts&&!t(document.activeElement).is(":input")?(s=null!=(o=this.currentContext)?o:this.registeredViews[i].tree,null!=s?this.execute(s,e.which):void 0):void 0},e.prototype.execute=function(t,e){var i,s,o,n,l,r,c=this;if(this.timeout&&clearTimeout(this.timeout),delete this.currentContext,e in t){if(t=t[e],0===t.upcoming)for(l=t.bindings,o=0,n=l.length;n>o;o++)i=l[o],s=null!=(r=i.context)?r:this.registeredViews[i.namespace].context,(!i.precondition||i.precondition.call(s))&&i.callback.call(s);else this.currentContext=t,this.timeout=setTimeout(function(){return c.execute(t)},this.options.jumpTime);return!1}},e.prototype.showKeyboardBindings=function(){var e,i;return null!=(i=this.constructor.view)&&i.$el.remove(),e=this.constructor.view=new Ribs.KeyboardHelpView({views:this.registeredViews,hotkeys:this.boundCharCodes}),e.render(),t("body").append(e.el)},e}(),Ribs.KeyboardHelpView=function(i){function s(){return s.__super__.constructor.apply(this,arguments)}return e(s,i),s.prototype.className="ribs-keyboard-shortcuts-overlay",s.prototype.events={click:"remove"},s.prototype.initialize=function(){return t(window).bind("keyup",function(t){return 27===t.which&&this.remove(),!1})},s.prototype.render=function(){var e,i,s,o,n,l,r,c;this.$el.empty(),r=this.options.views,c=[];for(o in r)l=r[o],t(l.el).is(":hidden")?c.push(void 0):(i=t.el.h1(l.label),n=t.el.ul(),this.$el.append(i,n),c.push(function(){var i,o,r,c;for(r=l.bindings,c=[],i=0,o=r.length;o>i;i++)e=r[i],s=t.el.li({"class":"hotkey"},t.el.span({"class":"key"},e.hotkey),t.el.span({"class":"action"},e.label)),c.push(t(n).append(s));return c}()));return c},s}(Backbone.View)})(jQuery)}).call(this);